#!/usr/bin/env ruby
# frozen_string_literal: true

require 'fileutils'
require 'open3'

class Generator
  attr_reader :spec, :app_dir, :example_dir

  def initialize(app_name)
    @spec = Gem::Specification.find_by_name('shopify-sinatra-app')
    gem_root = spec.gem_dir
    @example_dir = File.join(gem_root, 'example')

    working_dir = Dir.pwd
    @app_dir = File.join(working_dir, app_name.to_s.strip)

    log "Generating new app: #{app_name}"
    log "fullpath: #{app_dir}"
  end

  def run
    if Dir.exist?(app_dir)
      log "App directory already exists: #{app_dir}"
      log "Pick a new app name or delete the existing folder."
      return
    end

    unless Dir.exist?(example_dir)
      log "Example directory not found: #{example_dir}"
      return
    end

    copy_example_app
    create_dot_env
    sub_latest_version
    bundle_install
    migrate_database
  end

  private

  def copy_example_app
    FileUtils.cp_r(example_dir, app_dir)
  end

  def create_dot_env
    env_path = File.join(app_dir, '.env')

    # Don't overwrite if it already exists (safer for re-runs)
    if File.exist?(env_path)
      log ".env already exists, skipping: #{env_path}"
      return
    end

    contents = <<~ENVFILE
      SHOPIFY_API_KEY=your_api_key
      SHOPIFY_SHARED_SECRET=your_shared_secret
      SECRET=random_string_to_encrypt_credentials_with
    ENVFILE

    File.write(env_path, contents)
  end

  def sub_latest_version
    file_name = File.join(app_dir, 'Gemfile')
    unless File.exist?(file_name)
      log "Gemfile not found: #{file_name}"
      return
    end

    text = File.read(file_name)

    # Replace local path reference with current gem version constraint
    new_contents = text.gsub(
      "gem 'shopify-sinatra-app', path: '../'",
      "gem 'shopify-sinatra-app', '~> #{spec.version}'"
    )

    File.write(file_name, new_contents)
  end

  def bundle_install
    Dir.chdir(app_dir) do
      run_cmd('bundle install')
    end
  end

  def migrate_database
    Dir.chdir(app_dir) do
      run_cmd('bundle exec rake db:migrate')
    end
  end

  def run_cmd(cmd)
    log "â†’ #{cmd}"
    Open3.popen2e(cmd) do |_stdin, stdout_err, wait_thr|
      stdout_err.each { |line| print line }
      status = wait_thr.value
      raise "Command failed (#{status.exitstatus}): #{cmd}" unless status.success?
    end
  end

  def log(msg)
    puts msg
  end
end

if ARGV.length < 2 || ARGV[0] != 'new'
  puts "Usage:\nshopify-sinatra-app-generator new <app_name>"
  exit 1
end

app_name = ARGV[1]
Generator.new(app_name).run
