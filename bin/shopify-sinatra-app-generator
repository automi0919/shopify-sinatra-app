#!/usr/bin/env ruby
require 'fileutils'

class Generator
  attr_reader :app_dir, :example_dir

  def initialize(app_name)
    spec = Gem::Specification.find_by_name('shopify-sinatra-app')
    gem_root = spec.gem_dir
    @example_dir = gem_root + '/example'

    working_dir = Dir.pwd
    @app_dir = working_dir + '/' + app_name

    log "Generating new app: #{app_name}"
    log "fullpath: #{app_dir}"
  end

  def run
    new_app
    copy_example_app
    create_dot_env
    bundle_install
    migrate_database

  rescue Errno::EEXIST => e
    log 'App directory alread exists, pick a new app name or delete the existing folder'
  end

  private

  def new_app
    Dir.mkdir(app_dir)
  end

  def copy_example_app
    FileUtils.cp_r(example_dir, app_dir)
  end

  def create_dot_env
    FileUtils.touch(app_dir + '/.env')
    file = File.open(app_dir + '/.env', 'w')
    file.write("SHOPIFY_API_KEY=your_api_key\n")
    file.write("SHOPIFY_SHARED_SECRET=your_shared_secret\n")
    file.write("SECRET=random_string_to_encrypt_credentials_with\n")
    file.write("HOSTNAME=your_heroku_url\n")
    file.close
  end

  def bundle_install
    Dir.chdir(app_dir)

    pipe = IO.popen('bundle install')
    while (line = pipe.gets)
      print line
    end
  end

  def migrate_database
    Dir.chdir(app_dir)

    pipe = IO.popen('bundle exec rake db:migrate')
    while (line = pipe.gets)
      print line
    end
  end

  def log(msg)
    puts msg
  end
end

if ARGV.length < 2
  puts "Usage:\nshopify-sinatra-app-generator new <app_name>"
else
  app_name = ARGV[1]
  Generator.new(app_name).run
end
